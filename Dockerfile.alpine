ARG NODE_VERSION=20
FROM node:${NODE_VERSION}-alpine

ARG CLAUDE_CODE_VERSION=latest
ARG USERNAME=claude
ARG USER_UID=1000
ARG USER_GID=1000

# 1) System deps and useful tools (Alpine uses apk)
RUN apk add --no-cache \
    ca-certificates \
    curl \
    git \
    openssh-client \
    build-base \
    pkgconfig \
    unzip \
    gnupg \
    bash \
    sudo \
    dumb-init \
    ripgrep

# 2) Non-root user with passwordless sudo
RUN addgroup -g ${USER_GID} ${USERNAME} && \
    adduser -u ${USER_UID} -G ${USERNAME} -h /home/${USERNAME} -s /bin/bash -D ${USERNAME} && \
    echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/90-nopasswd && \
    chmod 0440 /etc/sudoers.d/90-nopasswd

WORKDIR /workspace
USER ${USERNAME}

# 3) Install mise (runtime version manager)
RUN curl https://mise.run | sh && \
    echo 'eval "$(~/.local/bin/mise activate bash)"' >> ~/.bashrc && \
    mkdir -p ~/.local/share/mise

# 4) Create entrypoint script that activates mise and installs tools
RUN printf '#!/bin/bash\neval "$(~/.local/bin/mise activate bash)"\nif [ -f /workspace/.mise.toml ]; then mise install; fi\nexec "$@"\n' > ~/.entrypoint.sh && \
    chmod +x ~/.entrypoint.sh

# Cache bust arg for rebuilding from this point
ARG CACHEBUST=1

# 5) Install Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code@${CLAUDE_CODE_VERSION} --prefix ~/.local || true

ENV PATH="/home/${USERNAME}/.local/share/mise/shims:/home/${USERNAME}/.local/bin:${PATH}"
ENV MISE_TRUSTED_CONFIG_PATHS=/workspace
ENV DISABLE_AUTOUPDATER=1
ENV DISABLE_TELEMETRY=1
ENV DISABLE_ERROR_REPORTING=1

ENTRYPOINT ["/usr/bin/dumb-init", "--", "/home/claude/.entrypoint.sh"]
CMD ["claude"]
